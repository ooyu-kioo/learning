## 3.1：依存関係を理解する

```rb
class Gear
  attr_reader :chainring, :cog, :rim, :tire
  def initialize(chainring, cog, rim, tire)
    @chainring = chainring
    @cog       = cog
    @rim       = rim
    @tire      = tire
  end
  def gear_inches
    ratio * Wheel.new(rim, tire).diameter
  end
  def ratio
    chainring / cog.to_f
  end
  # ...
end

class Wheel
  attr_reader :rim, :tire
  def initialize(rim, tire)
    @rim       = rim
    @tire      = tire
  end
  def diameter
    rim + (tire * 2)
  end
  # ...
end

Gear.new(52, 11, 26, 1.5).gear_inches 
```
現状、GearのWheelへの依存はかなり強い

#### 依存関係を認識する
あるobjectが他のobjに関して次のものを知っている時、依存関係がある
- 他のobjの名前：`Wheel.new()`
- self以外へのメッセージ(他のclassのmethod呼び出し)：`.diameter`
- メッセージが要求する引数・その順番：`.new(rim,tire)`

## 3.2：疎結合なコードを書く

#### 依存objの注入
現状のGearクラスには、wheelクラスの使用がハードコーディングされてる
= GearではWhell以外のdiatersを計算しない
=> 他のクラスのギアインチを計算したくなったら？依存があるとできない

wheelインスタンスの作成をGearから外だしすることで、一旦は再利用性が上がる
```rb
class Gear
  attr_reader :chainring, :cog, :wheel
  def initialize(chainring, cog, wheel)
    @chainring = chainring
    @cog       = cog
    @wheel     = wheel
  end
  def gear_inches
    ratio * wheel.diameter
  end
  # ...
end
# Gear は‘diameter’を知る‘Duck’を要求する。
Gear.new(52, 11, Wheel.new(26, 1.5)).gear_inches 
```

### 依存を隔離する

##### インスタンス変数の作成を分離する
上記のwheelをGearに注入することができない場合 => wheelのインスタンス生成をGear内で隔離する

```rb
# 差分のみ
def wheel
  @wheel ||= Wheel.new(rim, tire)
end
```
こうすることで、GearのWheelへの結合・依存は解消されていないが、明示され、他のmethodはきれいになる

##### 脆い外部メッセージを隔離する
上で外部クラスのinstance自体の隔離はしたんで、次はinstanceのmethodを隔離する

外部メッセージ=self以外に送られるメッセージ(wheel.delemeterのような)

```rb
# 差分のみ
def diameter
  wheel.diameter
end
```

### 引数の順番への依存を取り除く
あるクラスから他クラスへ引数が必要なメッセージを送る時、引数の順番まで依存関係が発生する

この場合、参照先の引数に変更が加えられた場合、参照元も変更しなければならない

##### 初期化の際の引数にハッシュを使う

hashのキーで参照先を定義してあげることで、変更を容易にする
```rb
# 参照先
def initialize(args)
  @chainring = args[:chainring]
  @cog       = args[:cog]
  @wheel     = args[:wheel]
end
# 参照元
Gear.new(
  :chainring => 52,
  :cog       => 11,
  :wheel     => Wheel.new(26, 1.5) ).gear_inches 
```

##### 明示的にデフォルト値を設定する
例えばこうできる
```rb
def initialize(args)
  @chainring = args[:chainring] || 40
  @cog       = args[:cog]       || 18
  @wheel     = args[:wheel]
end
```
ただこの場合、argsの値がbooleanの場合、
`@bool = args[:boolean_thing] || true `
例えばこの場合、falseを設定したくてもtrueになってしまう

なんで、fetchを使う
```rb
def initialize(args)
  @chainring = args.fetch(:chainring,40)
  @cog       = args.fetch(:cog,18)
  @wheel     = args[:wheel]
end
```

##### 複数のパラメータを用いた初期化を隔離する
